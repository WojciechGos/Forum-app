
<style type="text/css" scoped>
    .entry_finish_container{
        width: 100%;
        height: 10vh;
        display: flex;
        justify-content: center;
    }
</style>


<script>
    
    
    const post_container = document.querySelector('.post-container')
    let block = false
    let index= 2
    let filter_thread = null
    let currentDate = new Date().toISOString()
    initEntries()
    document.addEventListener('scroll', e=>{
        let entry
        
        if ((window.innerHeight + window.scrollY) >= document.body.scrollHeight) {
            for(let i=index; i<index+5; ++i){
                fetchAndAddEntry(i)
            }
            index += 5
        }

    })
    function blockFetch(){
        block = true
    }
    function isFetchBlocked(){
        return block
    }
    function initEntries(){
        for(let i=0; i<4; ++i){
            fetchAndAddEntry(i)
        }
        index = 4
        
    }
    function showError(){
        post_container += `
        <div class="entry_finish_container" >
            <button class="btn btn-primary">
                za≈Çaduj post
            </button>
        </div>
        `
    }

    async function fetchAndAddEntry(i){
        if(isFetchBlocked()){
            return 
        }
        entry = await fetchEntry(currentDate, i, 'none')
        
        console.log('recognizing ')
        if (entry.succes) {
            console.log("adding entry")
            addEntry(entry)
        }
        else {
            console.log('there is no entry')
            blockFetch()
            showError()
            // show info with button that enable refreshing info 
        }
    }


  
    function addEntry(data) {
        let user_name = data.user_name
        let thread = data.thread
        let date = data.date
        let title = data.title
        let content = data.content
            let entry =
                `<div class="card container-fluid">
                <div class="card-body">
                    <div class="row d-flex">
                        <div class="col">
                            ${user_name}
                        </div>
                        <div class="col">
                            ${thread}
                        </div>
                        <div class="col">
                            ${date}
                        </div>
                    </div>
                    <div class="row my-4">
                        <h4 class="card-title mb-3">
                            ${title}
                        </h4>
                        <p class="card-text">
                            ${content}   
                        </p>
                    </div>
                    <div class="row">
                        <p class="card-text">komentarze</p>
                    </div>
                </div>

            </div>`
        post_container.innerHTML += entry
    }

    

 

    function fetchEntry(date, index, thread) {
        console.log(date)
        let link = `entry/${date}/${index}/${thread}`
        return fetch(link, {
            method: "GET"
        })
        .then(response => {
            return response.json()
        })
        .then(data => {
            return data
        })
        .catch(e => {
            console.error(e)

        })
    }


</script>